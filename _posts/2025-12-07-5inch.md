---
layout: post
title:  "My 5inch quad"
lang: en
tags: [en, 6s, freestyle, quad, fpv, diy, analog, Walksnail, 5inch, gps, gps-rescue, PINIO]
category: tutorial
published: false
---

notes on my analog and Walksnail 5inch

## components



## wiring

analog
```
uart1 - vtx (irc tramp)
uart2 - ELRS (serial rx)
uart4 - Bluetooth (msp)
uart5, SCL(T3), SDA(R3) - GPS
```

## assembly (analog and Walksnail)

- add [TVS diode](https://oscarliang.com/using-tvs-diode-in-fpv-drone/) to the battery input on th ESC in addition to the capacitor. use solid state capacitor 470uF 35V, hard mount it (isolated) to the frame but connect to the PDB/ESC using wires, not it's leads (otherwise the leads will rip themselves out of the capacitor in a crash).
- install the Walksnail VTX, do **not** hard mount it to the frame, use rubber dampers and zip ties or a 3D-printed mount. otherwise the VTX casing will tear itself apart during a crash. keep the VTX case and antenna's shield isolated from the frame.
- solder VTX to FC's UART1 (or any other UART by default used by VTX) pins, but power it from +9v. measure the voltage on the 5V pad if there is no 9V pad on the FC, a FC had power on VTX pads marked 5V on the board but the pad was actually providing 9V.
- solder GPS module to the FC's default GPS UART, also solder SCL and SDA pins to the FC's I2C bus pins to connect the magnetometer. if the only free UART rx is used for ESC telemetry, set `Current meter source` to `onboard ADC` and set `ESC_SENSOR` to off in betaflight Power & Battery tab to free the UART. in Ports, set the UART's sensor to GPS, rate to 57600. place the GPS module as far away from digital VTX antennas as possible, inverse square law applies to RF interference.
- connect Walksnail VTX and DVR with the jumper cable (white dot aligns with the white wire, white wires are facing the side with u.fl connectors), flash them and the goggles with the same latest firmware https://caddxfpv.com/pages/download-center
  - remove the jumper cable
- upload [custom high resolution font](https://sneaky-fpv.gitbook.io/hd-osd-and-tools) to the goggles (Betaflight custom OSD font should not be called BTFL, otherwise Walksnail goggles will freeze and require restart when playing back OSD with DVR)
  - fonts
    - third party [720p 1080p](https://drive.google.com/drive/folders/1z4YXnn5RuUd2dZ7pjjoM5S6zSKITyb17) and [2.7k 4k](https://drive.google.com/drive/folders/1SFRYDwn_jhjZBqyDTO83O32kPZFMWBhT). `_24` suffix is for 720p, `_36` is for 1080p, `_40p` is for 2.7k, `_60p` is for 4k resolution.
    - another font for [1080p](https://github.com/fpv-wtf/msp-osd/blob/main/fonts/font_btfl.png) and [720p](https://github.com/fpv-wtf/msp-osd/blob/main/fonts/font_btfl_hd.png)
    - [other fonts](https://github.com/fpv-wtf/msp-osd?tab=readme-ov-file#suggested-third-party-fonts)
    - original: https://cdn.shopify.com/s/files/1/0036/3921/4169/files/FC_OSD_Font_Update.rar?v=1717745825
  - copy `font_update.ini` (duplicate sections to support switching between multiple FC systems) and the png files to the sd card and boot the goggles
  - manually set the font and the FC type in the goggles menu
- bind the goggles to the VTX
- add a layer of conformal coating after soldering all the wires. add more coating on the connectors after plugging them in. I used `Kafuter K-705`, but it's viscosity is too high so it makes a thick layer when spread on a PCB. `P-1025` forms a thinner layer. apply the coating to all the electronic boards (including all the edges of multilayer PCBs), all JST SH connectors and gaps on the VTX and camera casing. naturally, **leave out** the barometer chip on the FC (and the barometer on the GPS module like M10DQ), and be careful not to leak the compound onto the camera sensor. conformal coating **does not affect heat dissipation** of the ICs on the FC and ESCs, because it mainly happens through the PCB and the wires.
- add a rubber plug to the USB C port.
- (optional) add copper foil shielding covered with insulation tape to the cables (camera, GPS, VTX, RX).
- apply blue `Loctite-243` onto last threads of all _screws_ except those that
  - hold the camera
  - hold the top plate
- all wires must have some slack. multiple wires must be twisted together

## radio

- ch5 aux1 SB inverted (change the weight(mixes) to -100%) - right 3-pos: arm (high) - 
- ch6 aux2 SA inverted (change the weight(mixes) to -100%)  - left 3-pos: angle(high) / alt hold + pos hold (mid) / air (low)
- ch7 aux3 SC - left momentary sw - turtle mode
- ch8 aux4 S2 VTX power
- ch9 aux5 SD L2 - right momentary sw long - beeper
- ch10 aux6 sw1 failsafe
- ch11 aux7 (not set in radio) S1 OSD profiles
- ch12 aux8 sw6 G1 - Runcam button

## ESCs (Bluejay)
- props in
-  J-H-15 - Bluejay, 0.21.0, 48kHz
- use https://esc-configurator.com or [build the same app locally]({% post_url 2025-11-23-bf-local %}) to [flash and setup](https://oscarliang.com/bluejay-blheli-s/) latest Bluejay firmware to the ESCs
  - 48kHz PWM 
  - startup boost min 1010, max 1020
  - temperature protection Disabled
  - force EDT arm OFF
  - rampup x9
  - motor timing 22.5 degrees
- readjust motors direction, `set yaw_motors_reversed = ON` if some of the motors are being reversed (props out)
- beep strength and beacon strength must not be set too low, it will cause TELEM_DSHOT error at startup


## betaflight


- compile [the Betaflight Configurator app](https://app.betaflight.com/) [locally]({% post_url 2025-11-23-bf-local %})
  - `make GEPRCF722_BT_HD_V3 EXTRA_FLAGS="-D'RELEASE_NAME=2025.12.0-RC2' -DCLOUD_BUILD -DUSE_ACRO_TRAINER -DUSE_ALTITUDE_HOLD -DUSE_DSHOT -DUSE_GPS -DUSE_GPS_PLUS_CODES -DUSE_LED_STRIP -DUSE_MAG -DUSE_OSD -DUSE_OSD_SD -DUSE_PINIO -DUSE_POSITION_HOLD -DUSE_SERIALRX -DUSE_SERIALRX_CRSF -DUSE_TELEMETRY -DUSE_TELEMETRY_CRSF -DUSE_VTX"`
- check that FC is working, save the output of `dump` and `diff all showdefaults` to separate files
- for cloud builds:
  - `status` to find BUILD_KEY
  - `curl https://build.betaflight.com/api/builds/[BUILD KEY]/json | tee factory.json | jq` to find/save the features enabled in the current firmware. also `curl https://build.betaflight.com/api/builds/[BUILD KEY]/log`. the firmware itself is at `/hex`
- [build]({% post_url 2025-11-23-bf-local %}) the firmware locally, in CLI run `bl` to enter the bootloader mode and then flash the flight controller, adding features `Altitude Hold`, `Position Hold`, `Magnetometers`, and custom defines for the particular magnetometer microchip used, like `MAG MAG_QMC5883`
- restore parts of the diff as needed (for instance, PID and filter settings of profile0)
- disable location-related information in the ELRS telemetry:
  - ```
    set telemetry_disabled_altitude = ON
    set telemetry_disabled_lat_long = ON
    set telemetry_disabled_ground_speed = ON
    set telemetry_disabled_heading = ON
    save
    ```
- configure betaflight (issue `save` before leaving the CLI):

  - `set crash_recovery = DISARM` - self-explanatory, very helpful.
  - Power & Battery tab. [calibrate](https://oscarliang.com/current-sensor-calibration/) the voltage and amperage using an external multimeter.
  - calibrate the accelerometer. fly in angle mode and use [the stick commands](https://oscarliang.com/stick-commands/) to adjust trim: disarm, throttle up with yaw in the center and use the right stick to add roll or pitch trim iteratively with test flights until the quad hovers level.
  - if the GPS module also has a barometer that conflicts with the barometer on the flight controller (would manifest like this: the FC won't boot again after being powered on by USB only which doesn't power the GPS module and the FC's onboard barometer, and then saving changes to the FC's configuration), disable automatic barometer detection by `set baro_hardware = BMP280`
  - check [the datasheet for the magnetometer chip](https://datasheet.lcsc.com/szlcsc/QST-QMC5883L-TR_C192585.pdf) for its XYZ axis alignment, dry fit the GPS module on the drone frame with magnetometer axes pointing in the same directions as the [the default Betaflight directions](https://betaflight.com/docs/wiki/guides/current/Magnetometer), then set the actual installed orientation difference with in the CLI like
    ```
    set mag_hardware = QMC5883
    set align_mag = CUSTOM
    set mag_align_roll = 0
    set mag_align_pitch = 2150
    set mag_align_yaw = 0
    ```
    the rotation is centered around the dot on the microchip, so the pitch 215 means that the magnetometer chip was rotated (from the default alignment for the Betaflight, when X axis is pointing forward, Y axis is pointing to the left and Z axis is pointing up) 215 degrees counter-clockwise (pitch up rotation) around the dot on the chip on the Y axis when looking from the right side of the drone. pitch down rotation would be a negative value increasing from -360. might temporary enable debugging for `MAG_CALIB` in the blackbox tab to check the alignment on the sensors tab (`debug` checkbox). the axis pointing to the magnetic North will have the highest value.
  - find the correct [magnetic declination value for the region](https://www.magnetic-declination.com/), then set it in CLI like `set mag_declination = xxx` and `save`
  - calibrate the magnetometer
    - make note of the current values using `get mag`
    - _enter_ the calibration mode using stick commands: pitch low with roll centered, throttle high and yaw fully right
      - two short beeps would confirm entering the calibration mode
    - rotate the drone in any direction at a rate exceeding 350 deg/s to _begin_ the calibration
      - the beeper will beep fast 7 times, blue LED on the FC will go solid
    - rotate the drone (FC) around all 3 axes for 30 seconds
      - two long beeps - failure
      - three medium beeps - success. check with `get mag`
  - connect the controller and set up the modes:
    - arm set to high (set the mix weight to -100 in EdgeTX to invert the channel if needed)
      - also add `OR` with turtle mode channel to this mode, to bypass the need to rearm in turtle mode
    - angle, alt hold + pos hold, default (AIR mode)
    - beeper
    - turtle mode
    - failsafe
    - gps rescue
  - set up the `stage 1` failsafe. it is needed to get the drone into a level flight with a bit of recovery climb. for instance (numbering here starts from 0, 0-3 are the stick input channels): throttle (channel 4) set 1300, arm (channel 5) hold, angle mode (channel 6) set 2000
    ```
    # rxfail
    rxfail 3 s 1300
    rxfail 4 h
    rxfail 5 s 2000
    save
    ```
  - set up the `stage 2` failsafe, `failsafe_procedure = GPS-RESCUE`. auto-land is more problematic, because it's uncontrollable, does not account for the wind, and the motors will still be spinning for some time after landing until `failsafe_landing_time` runs out. it will disarm itself after `failsafe_landing_time` regardless it has landed or not, it will be midair if `failsafe_throttle` is not low enough. landing on a hard even surface is not a problem, and at 1100 throttle (1000 is idle and around 1275 is hover) it even should be enough for `crash_recovery` to disarm the drone. but it will be a problem if landing on uneven softer surface like grass, plus props being entangled in it will melt the prop's shafts and unwind the nuts even on idle speed. the same will happen if the drone bounce and flip while autolanding on a relatively hard surface, but the impact is not hard enough for `crash_recovery` to disarm it.

  - set up gps return to home (edit the altitude):

    ```
    set failsafe_delay = 15
    set failsafe_throttle_low_delay = 300
    set failsafe_procedure = GPS-RESCUE
    set gps_ublox_use_galileo = ON
    set gps_set_home_point_once = ON
    set gps_rescue_alt_mode = FIXED_ALT
    set gps_rescue_return_alt = 15
    set gps_rescue_ascend_rate = 1000
    set gps_rescue_ground_speed = 1500
    set gps_rescue_max_angle = 50
    set gps_rescue_descent_dist = 10
    set gps_rescue_min_sats = 6

    set failsafe_landing_time = 60
    set failsafe_throttle = 1100

    save
    ```

  - load `five33`, 533 rate profile (use Actual) as a starting point
  - load `RC_LINK` preset for the corresponding mode, for example, ELRS 150Hz (options:freestyle, serial, single cell)
  - in Motors tab, turn on bidirectional DShot, set highest protocol that is supported by the ESCs:

    ```
    set dshot_bidir = ON
    set motor_pwm_protocol = DSHOT600
    set dshot_edt = ON
    set vbat_warning_cell_voltage = 360
    set bat_capacity = 1050
    set baro_hardware = DPS310
    set motor_poles = 14
    set pid_process_denom = 1

    save
    ```


  - **props off**, check that [Extended DSHOT Telemetry](https://github.com/bird-sanctuary/bluejay/wiki/Setup#extended-dshot-telemetry---edt) is working:

    ```
    dshotprog 255 13
    motor 255 1060
    dshot_telemetry_info
    ```

  - in PID profile, set [dynamic idle depending on the propeller parameters](https://oscarliang.com/pid-filter-tuning-blackbox/#Anti-Gravity-Gains), anti-gravity, voltage sag compensation (depends on `vbat_warning_cell_voltage`), [thrust linearization](https://oscarliang.com/fpv-drone-tuning/#Thrust-Linearization):

    ```
    set dyn_idle_min_rpm = 40
    set vbat_sag_compensation = 100
    set thrust_linear = 20
    set anti_gravity_gain = 110
    set small_angle = 180
    set pidsum_limit = 1000
    set pidsum_limit_yaw = 1000
    save
    ```

  - `set motor_output_limit = 90` to [avoid burning the ESCs](https://www.youtube.com/watch?v=QQJ3yGproOg)

  - configure the blackbox for minimum logging of gyro data to use with [the Gyroflow](https://github.com/gyroflow/gyroflow) later. gyroflow Walksnail lens profile is [here](https://cdn.shopify.com/s/files/1/0036/3921/4169/files/Walksnail_Camera_Lens_Gyroflow_File.zip?v=1726298969). [gyroflow walksnail howto](https://www.youtube.com/watch?v=erYLYIYHWS4). download combined logs using download function in betaflight configurator, not removable media mode (and then erase the flash):
    ```
    set blackbox_mode = NORMAL
    set blackbox_sample_rate = 1/16
    set blackbox_disable_pids = ON
    set blackbox_disable_rc = ON
    set blackbox_disable_setpoint = ON
    set blackbox_disable_bat = ON
    set blackbox_disable_mag = ON
    set blackbox_disable_alt = ON
    set blackbox_disable_rssi = ON
    set blackbox_disable_debug = ON
    set blackbox_disable_motors = ON
    set blackbox_disable_gps = ON
    save
    ```
  - set up the OSD
    ```
    set osd_gps_sats_show_pdop = ON
    set osd_alt_alarm = 120
    set osd_rssi_dbm_alarm = -90
    save
    ```

- RSSI is on AUX12 (no need to configure it)

- `set crashflip_rate = 25` auto turtle mode

- in-flight VTX power switching on a pot, used S2 (BF:aux4, radio:ch8). 0 means no change. I omit the last most powerful level.
  `<index> <aux_channel> <vtx_band> <vtx_channel> <vtx_power> <start_range> <end_range>`

```
vtx 0 3 0 0 1 900 1300
vtx 1 3 0 0 2 1300 1600
vtx 2 3 0 0 3 1600 2100

```

- in-flight OSD profile switching on a pot. I use S1, set it to CH11 (AUX7 in BF)

```
adjrange 0 0 6 900 2100 29 6 0 0
```

## filter tuning

- blackbox settings for filter tuning (2khz)

```
set debug_mode = GYRO_RAW
set blackbox_mode = NORMAL
set blackbox_sample_rate = 1/2

set blackbox_disable_gyro = OFF
set blackbox_disable_debug = OFF
set blackbox_disable_motors = OFF
set blackbox_disable_setpoint = OFF
set blackbox_disable_pids = OFF
set blackbox_disable_rc = OFF
set blackbox_disable_gyrounfilt = OFF

set blackbox_disable_bat = ON
set blackbox_disable_alt = ON
set blackbox_disable_rssi = ON
set blackbox_disable_acc = ON
set blackbox_disable_attitude = ON
set blackbox_disable_gps = ON
set blackbox_disable_mag = ON
```

## runcam

[the shell](https://www.thingiverse.com/thing:6830398)

## runcam camera control with PINIO

https://www.betaflight.com/docs/wiki/guides/current/Pinio-and-PinioBox

compile Betaflight with led_strip, enable led strip in configuration tab. set switch to `trigger` mode in edgetx. pad signal is inverted by adding 128 to 1 in box2, so triggering `user1` sets the LED_STRIP pad momentarily to LOW (0V)

original

```
resource LED_STRIP 1 A01
resource PINIO 1 C13
resource PINIO 2 C14
pinio_config = 129,1,1,1
pinio_box = 0,40,255,255
```

actual change

```
resource LED_STRIP 1 none
resource pinio 2 A01
set pinio_config = 129,129,1,1
set pinio_box = 0,40,255,255
save
```